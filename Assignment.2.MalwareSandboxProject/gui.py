import tkinter as tk
from tkinter import filedialog, scrolledtext
from sandbox_monitor import SandboxEngine
import threading
import os
from datetime import datetime

# --- Color Palette (Cyberpunk / Dark Mode) ---
COLOR_BG_MAIN = "#121212"       # Very dark grey (almost black)
COLOR_BG_SEC = "#1e1e1e"        # Slightly lighter grey for panels
COLOR_TEXT = "#e0e0e0"          # Off-white for text
COLOR_ACCENT = "#03dac6"        # Cyan/Teal for highlights
COLOR_DANGER = "#cf6679"        # Muted Red for errors/stops
COLOR_BUTTON = "#333333"        # Dark Grey for buttons
COLOR_BUTTON_HOVER = "#444444" 

# --- Fonts ---
FONT_HEADER = ("Segoe UI", 16, "bold")
FONT_NORMAL = ("Segoe UI", 10)
FONT_MONO = ("Consolas", 10)

class SandboxApp(tk.Tk):
    def __init__(self):
        super().__init__()
        self.title("Malware Analysis Sandbox - Native Dark Mode")
        self.geometry("1000x700")
        self.configure(bg=COLOR_BG_MAIN) # Set window background

        # Main Container with padding
        main_container = tk.Frame(self, bg=COLOR_BG_MAIN)
        main_container.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)

        # --- Header Section ---
        header_frame = tk.Frame(main_container, bg=COLOR_BG_MAIN)
        header_frame.pack(fill=tk.X, pady=(0, 20))
        
        title_lbl = tk.Label(
            header_frame, 
            text="MALWARE ANALYSIS SANDBOX", 
            font=FONT_HEADER, 
            bg=COLOR_BG_MAIN, 
            fg=COLOR_DANGER
        )
        title_lbl.pack(side=tk.LEFT)
        
        self.status_lbl = tk.Label(
            header_frame, 
            text="STATUS: IDLE", 
            font=FONT_MONO, 
            bg=COLOR_BG_MAIN, 
            fg="#888888"
        )
        self.status_lbl.pack(side=tk.RIGHT, anchor="e")

        # --- File Selection Section ---
        # We use a Frame to simulate a "Card" look
        file_frame = tk.Frame(main_container, bg=COLOR_BG_SEC, bd=1, relief="flat")
        file_frame.pack(fill=tk.X, pady=(0, 15), ipady=5)

        tk.Label(file_frame, text=" TARGET SELECTION ", bg=COLOR_BG_SEC, fg=COLOR_ACCENT, font=("Segoe UI", 9, "bold")).pack(anchor="w", padx=10, pady=5)

        input_container = tk.Frame(file_frame, bg=COLOR_BG_SEC)
        input_container.pack(fill=tk.X, padx=10, pady=(0, 10))

        self.file_entry = tk.Entry(
            input_container, 
            bg="#2d2d2d", 
            fg="white", 
            insertbackground="white", 
            relief="flat",
            font=FONT_NORMAL
        )
        self.file_entry.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=(0, 10), ipady=4)
        
        # Stylized Button
        self.btn_browse = tk.Button(
            input_container, 
            text="BROWSE", 
            command=self.select_file,
            bg=COLOR_ACCENT, 
            fg="black",
            font=("Segoe UI", 9, "bold"),
            relief="flat",
            activebackground="#00bbb0",
            cursor="hand2",
            padx=15, pady=2
        )
        self.btn_browse.pack(side=tk.LEFT)
        
        self.file_path = None

        # --- Logs Section ---
        log_frame = tk.Frame(main_container, bg=COLOR_BG_SEC, bd=1, relief="flat")
        log_frame.pack(fill=tk.BOTH, expand=True, pady=(0, 15))

        tk.Label(log_frame, text=" LIVE ANALYSIS FEED ", bg=COLOR_BG_SEC, fg="#4caf50", font=("Segoe UI", 9, "bold")).pack(anchor="w", padx=10, pady=5)

        self.log_area = scrolledtext.ScrolledText(
            log_frame, 
            state='disabled', 
            height=20, 
            font=FONT_MONO,
            bg="#0f0f0f",    # Pure black for terminal feel
            fg=COLOR_TEXT,   # Default text color
            insertbackground="white",
            relief="flat",
            bd=0
        )
        self.log_area.pack(fill=tk.BOTH, expand=True, padx=10, pady=(0, 10))

        # Syntax Highlighting Tags
        self.log_area.tag_config("timestamp", foreground="#666666") 
        self.log_area.tag_config("danger", foreground="#ff5252")    # Red
        self.log_area.tag_config("warning", foreground="#ffb74d")   # Orange
        self.log_area.tag_config("success", foreground="#69f0ae")   # Green
        self.log_area.tag_config("network", foreground="#40c4ff")   # Light Blue
        self.log_area.tag_config("info", foreground="#ffffff")      # White

        # --- Control Section ---
        control_frame = tk.Frame(main_container, bg=COLOR_BG_MAIN)
        control_frame.pack(fill=tk.X)

        self.btn_start = tk.Button(
            control_frame, 
            text="INITIATE ANALYSIS", 
            command=self.start_analysis, 
            bg="#2d2d2d", # Disabled color initially
            fg="#666666",
            font=("Segoe UI", 11, "bold"),
            relief="flat",
            state='disabled',
            cursor="arrow",
            padx=20, pady=8
        )
        self.btn_start.pack(side=tk.LEFT)

        self.btn_report = tk.Button(
            control_frame, 
            text="EXPORT REPORT", 
            command=self.save_report, 
            bg=COLOR_BUTTON,
            fg="white",
            font=("Segoe UI", 10),
            relief="flat",
            activebackground=COLOR_BUTTON_HOVER,
            activeforeground="white",
            cursor="hand2",
            padx=20, pady=8
        )
        self.btn_report.pack(side=tk.RIGHT)

        # Engine Initialization
        self.engine = SandboxEngine(self.log_message)

    def log_message(self, message):
        # Determine tag for coloring
        tag = "info"
        if "[FILE DELETED]" in message or "ERROR" in message or "ALERT" in message:
            tag = "danger"
        elif "[FILE RENAMED]" in message:
            tag = "warning"
        elif "[FILE CREATED]" in message:
            tag = "success"
        elif "[NET]" in message:
            tag = "network"
        
        timestamp = datetime.now().strftime("%H:%M:%S")
        
        def _update():
            self.log_area.config(state='normal')
            self.log_area.insert(tk.END, f"[{timestamp}] ", "timestamp")
            self.log_area.insert(tk.END, f"{message}\n", tag)
            self.log_area.see(tk.END)
            self.log_area.config(state='disabled')
        
        self.after(0, _update)

    def select_file(self):
        filename = filedialog.askopenfilename(
            title="Select Malware Sample", 
            filetypes=[
                ("All Executables", "*.py *.exe *.bat"),
                ("Python Files", "*.py"),
                ("Executables", "*.exe")
            ])
        
        if filename:
            self.file_path = filename
            self.file_entry.delete(0, tk.END)
            self.file_entry.insert(0, filename)
            
            # Enable Start Button with 'Danger' color
            self.btn_start.config(state='normal', bg=COLOR_DANGER, fg="black", activebackground="#a85260", cursor="hand2")
            self.status_lbl.config(text="STATUS: READY", fg=COLOR_ACCENT)

    def start_analysis(self):
        if not self.file_path:
            return
        
        self.status_lbl.config(text="STATUS: RUNNING", fg=COLOR_DANGER)
        self.log_message("--- INITIALIZING ISOLATED ENVIRONMENT ---")
        
        target_dir = os.path.dirname(self.file_path)
        
        self.btn_start.config(state='disabled', bg="#2d2d2d", fg="#666666", cursor="arrow")
        
        t = threading.Thread(target=self._run_engine, args=(target_dir,))
        t.start()

    def _run_engine(self, target_dir):
        self.engine.start_monitoring(target_dir)
        self.engine.execute_sample(self.file_path)
        
        self.after(0, lambda: self.status_lbl.config(text="STATUS: FINISHED", fg="#4caf50"))
        # Re-enable button after slight delay
        self.after(2000, lambda: self.btn_start.config(state='normal', bg=COLOR_DANGER, fg="black", cursor="hand2"))

    def save_report(self):
        report_content = self.log_area.get("1.0", tk.END)
        filename = f"analysis_report_{int(datetime.now().timestamp())}.txt"
        with open(filename, "w") as f:
            f.write(report_content)
        self.log_message(f"Report exported to {filename}")