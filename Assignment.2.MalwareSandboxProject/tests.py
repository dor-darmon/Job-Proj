import unittest
import os
import time
import shutil
import threading
from sandbox_monitor import SandboxEngine

class TestMalwareSandbox(unittest.TestCase):
    """
    Automated tests for the Sandbox Engine to ensure it correctly
    detects file system events without needing a UI.
    """

    def setUp(self):
        # 1. Setup: Runs before every test
        # Create a temporary directory for testing isolation
        self.test_dir = "temp_test_env"
        if os.path.exists(self.test_dir):
            shutil.rmtree(self.test_dir)
        os.makedirs(self.test_dir)

        # List to capture logs instead of printing to GUI
        self.captured_logs = []

        # Initialize the engine with a mock logger
        self.engine = SandboxEngine(self.mock_log_callback)
        
        # Start monitoring the temp directory
        self.engine.start_monitoring(self.test_dir)
        
        # Give the observer a moment to start
        time.sleep(1)

    def mock_log_callback(self, message):
        # Instead of sending to GUI, store in list for verification
        self.captured_logs.append(message)

    def test_file_creation_detection(self):
        # Test Case 1: Does it detect file creation?
        file_path = os.path.join(self.test_dir, "virus.exe")
        
        # Action: Create a file
        with open(file_path, "w") as f:
            f.write("malicious code")
        
        time.sleep(1) # Wait for watchdog to catch the event

        # Assertion: Check if logs contain the specific event
        found = any("[FILE CREATED]" in log for log in self.captured_logs)
        self.assertTrue(found, "Failed to detect file creation!")

    def test_ransomware_rename_detection(self):
        # Test Case 2: Does it detect renaming (Ransomware behavior)?
        original_path = os.path.join(self.test_dir, "doc.txt")
        encrypted_path = os.path.join(self.test_dir, "doc.txt.encrypted")

        # Create original file
        with open(original_path, "w") as f:
            f.write("data")
        time.sleep(1) 
        
        # Action: Rename the file
        os.rename(original_path, encrypted_path)
        time.sleep(1)

        # Assertion: Check for rename event
        found = any("[FILE RENAMED]" in log for log in self.captured_logs)
        self.assertTrue(found, "Failed to detect file renaming (Ransomware simulation)!")

    def test_file_deletion_detection(self):
        # Test Case 3: Does it detect deletion?
        file_path = os.path.join(self.test_dir, "evidence.log")
        
        # Create file first
        with open(file_path, "w") as f:
            f.write("logs")
        time.sleep(1)
        
        # Action: Delete the file
        os.remove(file_path)
        time.sleep(1)

        # Assertion
        found = any("[FILE DELETED]" in log for log in self.captured_logs)
        self.assertTrue(found, "Failed to detect file deletion!")

    def tearDown(self):
        # Cleanup: Runs after every test
        self.engine.stop_monitoring()
        time.sleep(0.5)
        # Delete the temp directory
        if os.path.exists(self.test_dir):
            shutil.rmtree(self.test_dir)

if __name__ == "__main__":
    unittest.main()