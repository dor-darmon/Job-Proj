import os
import time
import socket
import platform

def simulate_system_recon():
    # Simulate Spyware behavior: Gathering system information
    print("Gathering system info...")
    # Get OS and release version
    info = f"System: {platform.system()} {platform.release()}"
    
    # Write stolen info to a file (triggers file creation event)
    with open("stolen_info.log", "w") as f:
        f.write(info)

def simulate_ransomware_behavior():
    # Simulate Ransomware behavior: Creating and renaming files
    print("Simulating encryption...")
    for i in range(3):
        fname = f"important_doc_{i}.txt"
        
        # Create dummy file with sensitive data
        with open(fname, "w") as f:
            f.write("Sensitive Data")
        
        time.sleep(0.5)
        # Rename the file to simulate encryption extension change
        # This triggers the 'on_moved' event in the sandbox
        os.rename(fname, f"{fname}.encrypted")

def simulate_network_activity():
    # Simulate C&C communication (connects to Google DNS safely)
    print("Attempting to connect to external server...")
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.settimeout(2)
        # Connect to a public IP (8.8.8.8) to simulate network traffic
        s.connect(("8.8.8.8", 53)) 
        s.send(b"exfiltrating_data")
        # Sleep to keep socket open for the monitor to capture it
        time.sleep(2) 
        s.close()
    except Exception as e:
        print(f"Network simulation error: {e}")

def cleanup_evidence():
    # Simulates 'Covering Tracks' - Deleting created files
    print("Cleaning up evidence...")
    
    # List of files to be removed
    files_to_remove = ["stolen_info.log"]
    for i in range(3):
        files_to_remove.append(f"important_doc_{i}.txt.encrypted")

    # Remove each file if it exists
    for file_path in files_to_remove:
        if os.path.exists(file_path):
            try:
                os.remove(file_path)
                print(f"Deleted: {file_path}")
            except Exception as e:
                print(f"Error deleting {file_path}: {e}")

def main():
    print("--- MALWARE STARTING ---")
    simulate_system_recon()
    time.sleep(1)
    simulate_ransomware_behavior()
    time.sleep(1)
    simulate_network_activity()
    
    # Wait a moment before cleaning up so the Sandbox can register events
    time.sleep(2)
    cleanup_evidence()
    
    print("--- MALWARE FINISHED ---")

if __name__ == "__main__":
    main()